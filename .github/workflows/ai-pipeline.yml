name: AI Pipeline & CI/CD

on:
  push:
    branches: [ "main", "dev", "ai-updates" ]
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  # 1. VALIDATION & SECURITY CHECK
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Type Check & Lint
        run: |
          # If you have lint scripts configured
          # npm run lint
          echo "Linting skipped (add script to package.json)"

      - name: Build Verification
        run: npm run build

  # 2. AI AUTO-MERGE (Runs only on ai-updates branch)
  ai-automerge:
    needs: validate
    if: github.ref == 'refs/heads/ai-updates'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create & Merge PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          git fetch origin dev
          
          # Check for existing PR
          PR_URL=$(gh pr list --head ai-updates --base dev --json url --jq '.[0].url')
          
          if [ -z "$PR_URL" ]; then
            echo "üöÄ Creating new Pull Request..."
            PR_URL=$(gh pr create \
              --base dev \
              --head ai-updates \
              --title "ü§ñ AI Autonomous Update" \
              --body "Automated changes passed CI validation. This PR was automatically generated by the Antigravity Pipeline.")
          else
            echo "‚ÑπÔ∏è Pull Request already exists: $PR_URL"
          fi
          
          # Attempt Auto-Merge
          if [ -n "$PR_URL" ]; then
            echo "üîÑ Enabling Auto-Merge for $PR_URL..."
            # Using --auto and --squash. If protection rules are met, it will merge instantly.
            # If rules (like reviews) are required, it will merge as soon as they are satisfied.
            gh pr merge "$PR_URL" --auto --squash --delete-branch || {
              echo "‚ö†Ô∏è Auto-merge could not be enabled. This usually means branch protection rules require manual approval."
              echo "Please review the PR manually: $PR_URL"
            }
          fi

  # 3. DEPLOYMENT NOTIFICATION (Optional - real deploy is handled by Vercel Integration)
  notify-deploy:
    needs: validate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Log Deployment
        run: echo "Code pushed to main. Vercel should pick this up automatically."
