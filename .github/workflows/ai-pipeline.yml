name: AI Pipeline & CI/CD

on:
  push:
    branches: [ "main", "dev", "ai-updates" ]
  pull_request:
    branches: [ "main", "dev" ]
  workflow_dispatch:

permissions:
  contents: write
  pull-requests: write
  checks: write

jobs:
  # 1. VALIDATION & SECURITY CHECK
  validate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          
      - name: Install Dependencies
        run: npm ci
        
      - name: Type Check & Lint
        run: |
          # If you have lint scripts configured
          # npm run lint
          echo "Linting skipped (add script to package.json)"

      - name: Build Verification
        run: npm run build

  # 2. AI AUTO-MERGE (Runs only on ai-updates branch)
  ai-automerge:
    needs: validate
    if: github.ref == 'refs/heads/ai-updates'
    runs-on: ubuntu-latest
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    steps:
      - uses: actions/checkout@v4
      
      - name: Create & Merge PR
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          
          # Ensure local runner is aware of remote branches
          git fetch origin --unshallow || git fetch origin
          
          # Check if PR already exists
          PR_URL=$(gh pr list --head ai-updates --base dev --json url --jq '.[0].url')
          
          if [ -z "$PR_URL" ]; then
            echo "Creating new PR..."
            PR_URL=$(gh pr create --base dev --head ai-updates --title "ðŸ¤– AI Autonomous Update" --body "Automated changes passed CI validation.")
          else
            echo "PR already exists: $PR_URL"
          fi
          
          # Merge PR if URL exists
          if [ -n "$PR_URL" ]; then
            gh pr merge "$PR_URL" --squash --delete-branch
          else
            echo "Error: Could not identify PR URL to merge."
            exit 1
          fi

  # 3. DEPLOYMENT NOTIFICATION (Optional - real deploy is handled by Vercel Integration)
  notify-deploy:
    needs: validate
    if: github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    steps:
      - name: Log Deployment
        run: echo "Code pushed to main. Vercel should pick this up automatically."
