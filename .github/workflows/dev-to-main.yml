name: Auto Merge Dev to Main

on:
  push:
    branches:
      - dev

jobs:
  merge-dev-to-main:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch All Branches
        run: |
          git fetch origin main:main
          git fetch origin dev:dev

      - name: Create Pull Request
        id: create-pr
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # Check if PR already exists
          EXISTING_PR=$(gh pr list --head dev --base main --state open --json number --jq '.[0].number')
          
          if [ -n "$EXISTING_PR" ]; then
            echo "PR already exists: #$EXISTING_PR"
            echo "pr_number=$EXISTING_PR" >> $GITHUB_OUTPUT
          else
            # Create new PR
            PR_URL=$(gh pr create \
              --title "Auto-merge: Dev â†’ Main" \
              --body "Automated merge from dev to main branch" \
              --base main \
              --head dev)
            
            PR_NUMBER=$(echo $PR_URL | grep -oP '\d+$')
            echo "Created PR: #$PR_NUMBER"
            echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          fi

      - name: Enable Auto-Merge (Safe Method)
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER="${{ steps.create-pr.outputs.pr_number }}"
          
          # Enable auto-merge instead of immediate merge
          # This respects branch protection rules
          gh pr merge $PR_NUMBER --auto --squash || {
            echo "âš ï¸ Auto-merge failed. PR #$PR_NUMBER needs manual review."
            echo "This usually means branch protection rules are active."
            echo "Visit: https://github.com/${{ github.repository }}/pull/$PR_NUMBER"
            exit 0  # Don't fail the workflow
          }

      - name: PR Status Summary
        if: always()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“‹ Workflow Summary"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "Repository: ${{ github.repository }}"
          echo "PR Number: #${{ steps.create-pr.outputs.pr_number }}"
          echo "Status: Check PR page for merge status"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
